// Prisma schema file for SEF eFakture application

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id          String  @id @default(uuid())
  pib         String  @unique @db.VarChar(9)
  name        String
  address     String
  city        String
  postalCode  String  @map("postal_code")
  country     String  @default("RS")
  email       String?
  phone       String?
  bankAccount String? @map("bank_account")
  vatNumber   String? @map("vat_number")

  // SEF Configuration
  sefApiKey      String? @map("sef_api_key")
  sefEnvironment String? @map("sef_environment") // demo or production

  // Stock Management Settings
  autoStockDeduction Boolean @default(false) @map("auto_stock_deduction")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users           User[]
  invoices        Invoice[]
  partners        Partner[]
  products        Product[]
  accounts        Account[]
  fiscalYears     FiscalYear[]
  journalEntries  JournalEntry[]
  vatRecords      VATRecord[]
  bankStatements  BankStatement[]
  creditNotes     CreditNote[]
  incomingInvoices IncomingInvoice[]
  recurringInvoices RecurringInvoice[]
  inventoryTransactions InventoryTransaction[]
  
  // New Modules
  calculations    Calculation[]
  fixedAssets     FixedAsset[]
  pettyCashAccounts PettyCashAccount[]
  travelOrders    TravelOrder[]
  sefVatEvidence  SefVatEvidence[]
  
  // Additional Modules
  pppdvReports    PPPDVReport[]
  kpoEntries      KPOEntry[]
  compensations   Compensation[]
  iosReports      IOSReport[]
  advanceInvoices AdvanceInvoice[]
  emailTemplates  EmailTemplate[]
  emailLogs       EmailLog[]
  cashFlowForecasts CashFlowForecast[]

  @@map("companies")
}

// ========================================
// PARTNER ŠIFARNIK (Dobavljači i Kupci)
// ========================================
model Partner {
  id   String      @id @default(uuid())
  type PartnerType

  // Osnovni podaci
  pib       String  @db.VarChar(9)
  name      String
  shortName String? @map("short_name")

  // Adresa
  address    String
  city       String
  postalCode String @map("postal_code")
  country    String @default("RS")

  // Kontakt informacije
  email         String?
  phone         String?
  fax           String?
  website       String?
  contactPerson String? @map("contact_person") @db.Text

  // PDV status
  vatPayer  Boolean @default(true) @map("vat_payer")
  vatNumber String? @map("vat_number")

  // Platni uslovi
  defaultPaymentTerms Int      @default(15) @map("default_payment_terms") // Dana
  creditLimit         Decimal? @map("credit_limit") @db.Decimal(15, 2)
  discount            Decimal? @default(0) @db.Decimal(5, 2) // Procenat popusta

  // Bankovni računi (JSON array)
  bankAccounts Json? @map("bank_accounts")

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Napomene
  note String? @db.Text

  // Company relation
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  invoices Invoice[] @relation("PartnerInvoices")
  recurringInvoices RecurringInvoice[]
  calculations      Calculation[]
  compensations     Compensation[]
  iosReports        IOSReport[]
  advanceInvoices   AdvanceInvoice[]

  // Indexes
  @@unique([companyId, pib], name: "unique_partner_pib_per_company")
  
  // Single-column indexes
  @@index([companyId])
  @@index([type])
  @@index([pib])
  @@index([isActive])
  @@index([name]) // For autocomplete/search
  
  // Composite indexes for common queries
  @@index([companyId, type, isActive])
  @@index([companyId, isActive, name])
  @@index([companyId, type])
  @@index([companyId, createdAt(sort: Desc)])
  
  @@map("partners")
}

// ========================================
// PRODUCT ŠIFARNIK (Proizvodi i Usluge)
// ========================================
model Product {
  id String @id @default(uuid())

  // Identifikacija
  code        String // Šifra artikla (SKU)
  barcode     String? // Barkod
  name        String
  description String? @db.Text

  // Kategorija
  category    String?
  subcategory String?

  // Cene
  unitPrice Decimal  @map("unit_price") @db.Decimal(15, 2)
  costPrice Decimal? @map("cost_price") @db.Decimal(15, 2) // Nabavna cena
  currency  String   @default("RSD")

  // PDV
  vatRate Decimal @map("vat_rate") @db.Decimal(5, 2) // 20, 10, 0

  // Jedinica mere
  unit String @default("kom") // kom, kg, m, l, h, dan, usluga

  // Magacin
  trackInventory Boolean  @default(false) @map("track_inventory")
  currentStock   Decimal  @default(0) @map("current_stock") @db.Decimal(15, 3)
  minStock       Decimal? @map("min_stock") @db.Decimal(15, 3)
  maxStock       Decimal? @map("max_stock") @db.Decimal(15, 3)

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Dodatne informacije
  supplier     String? // Glavni dobavljač
  manufacturer String? // Proizvođač
  note         String? @db.Text

  // Company relation
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  invoiceLines InvoiceLine[]
  incomingInvoiceLines IncomingInvoiceLine[]
  inventoryTransactions InventoryTransaction[]
  
  // Production relations
  bomAsFinishedGood ProductBOM[] @relation("ProductAsFinishedGood")
  bomAsComponent    ProductBOM[] @relation("ProductAsComponent")
  calculationItems  CalculationItem[]

  // Indexes
  @@unique([companyId, code], name: "unique_product_code_per_company")
  
  // Single-column indexes
  @@index([companyId])
  @@index([barcode])
  @@index([isActive])
  @@index([category])
  @@index([name]) // For autocomplete/search
  @@index([code]) // For quick lookup
  
  // Composite indexes for common queries
  @@index([companyId, isActive, name])
  @@index([companyId, category, isActive])
  @@index([companyId, trackInventory, currentStock])
  @@index([companyId, isActive, category])
  @@index([companyId, createdAt(sort: Desc)])
  
  @@map("products")
}

// ========================================
// ENUMS (definisati PRE modela koji ih koriste)
// ========================================
enum PartnerType {
  BUYER // Samo kupac
  SUPPLIER // Samo dobavljač
  BOTH // I kupac i dobavljač
}

enum InvoicePaymentStatus {
  UNPAID // Neplaćeno
  PARTIALLY_PAID // Delimično plaćeno
  PAID // Plaćeno
  OVERDUE // Rok istekao
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  password  String
  role      UserRole
  permissions Json?    @map("permissions") // Granular permissions
  isActive  Boolean  @default(true) @map("is_active")
  companyId String   @map("company_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  refreshTokens       RefreshToken[]
  notifications       Notification[]
  passwordResetTokens PasswordResetToken[]

  // Indexes for performance
  @@index([companyId])
  @@index([email])
  @@index([isActive])
  @@index([companyId, isActive])
  @@map("users")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  usedAt    DateTime? @map("used_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String    @map("user_id")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revoked   Boolean   @default(false)
  revokedAt DateTime? @map("revoked_at")

  // Device/session info for security
  userAgent String? @map("user_agent") @db.Text
  ipAddress String? @map("ip_address")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([userId, revoked])
  @@map("refresh_tokens")
}

model Invoice {
  id            String        @id @default(uuid())
  sefId         String?       @unique @map("sef_id")
  sefStatus     String?       @map("sef_status")
  invoiceNumber String        @map("invoice_number")
  issueDate     DateTime      @map("issue_date")
  dueDate       DateTime?     @map("due_date")
  status        InvoiceStatus @default(DRAFT)
  type          InvoiceType   @default(OUTGOING)

  // Partner relations (NEW - replacing hardcoded buyer fields)
  partnerId String?  @map("partner_id") // Reference to Partner šifarnik
  partner   Partner? @relation("PartnerInvoices", fields: [partnerId], references: [id], onDelete: SetNull)

  // Legacy buyer fields (DEPRECATED - keeping for backward compatibility during migration)
  // TODO: Remove after data migration
  buyerName       String? @map("buyer_name")
  buyerPIB        String? @map("buyer_pib")
  buyerAddress    String? @map("buyer_address")
  buyerCity       String? @map("buyer_city")
  buyerPostalCode String? @map("buyer_postal_code")

  // Amounts
  totalAmount Decimal @map("total_amount") @db.Decimal(15, 2)
  taxAmount   Decimal @map("tax_amount") @db.Decimal(15, 2)
  currency    String  @default("RSD") @db.VarChar(3)

  // Payment tracking (NEW)
  paymentStatus InvoicePaymentStatus @default(UNPAID) @map("payment_status")
  paidAmount    Decimal              @default(0) @map("paid_amount") @db.Decimal(15, 2)

  // Optional UBL XML snapshot
  ublXml String? @map("ubl_xml") @db.Text

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  sentAt    DateTime? @map("sent_at")

  // Notes
  note String? @db.Text

  // Company relation (issuer)
  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Relations
  lines     InvoiceLine[]
  // auditLogs AuditLog[]
  payments  Payment[]

  // Unique constraint: invoice number must be unique per company
  @@unique([companyId, invoiceNumber], name: "unique_invoice_number_per_company")
  
  // Indexes for performance
  // Basic single-column indexes
  @@index([companyId])
  @@index([partnerId])
  @@index([status])
  @@index([paymentStatus])
  @@index([issueDate])
  @@index([dueDate])
  @@index([sefId])
  @@index([invoiceNumber])
  @@index([buyerPIB])
  @@index([createdAt])
  @@index([sentAt])
  @@index([type])
  
  // Composite indexes for common query patterns
  // List invoices by company and status
  @@index([companyId, status, issueDate(sort: Desc)])
  
  // List invoices by company and payment status
  @@index([companyId, paymentStatus, dueDate])
  
  // List invoices by company and type
  @@index([companyId, type, status])
  
  // Search invoices by date range (most common)
  @@index([companyId, issueDate(sort: Desc), status])
  
  // Find overdue invoices
  @@index([companyId, paymentStatus, dueDate], name: "idx_overdue_invoices")
  
  // Partner lookup for invoices
  @@index([partnerId, issueDate(sort: Desc)])
  
  // SEF integration queries
  @@index([sefId, status])
  @@index([companyId, sefStatus])
  
  // Recent invoices (dashboard queries)
  @@index([companyId, createdAt(sort: Desc)])
  @@index([companyId, sentAt(sort: Desc)])
  
  @@map("invoices")
}

model InvoiceLine {
  id         String @id @default(uuid())
  invoiceId  String @map("invoice_id")
  lineNumber Int    @map("line_number")

  // Product relation (NEW - optional for legacy data)
  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  // Item details (legacy + current)
  itemName        String  @map("item_name")
  itemDescription String? @map("item_description") @db.Text

  // Quantities and prices
  quantity  Decimal @db.Decimal(10, 3)
  unit      String  @default("kom")
  unitPrice Decimal @map("unit_price") @db.Decimal(15, 2)

  // Tax
  taxRate   Decimal @map("tax_rate") @db.Decimal(5, 2)
  taxAmount Decimal @map("tax_amount") @db.Decimal(15, 2)

  // Total amount
  amount Decimal @db.Decimal(15, 2)

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Indexes for performance
  @@index([invoiceId])
  @@index([productId])
  @@index([invoiceId, lineNumber])
  @@map("invoice_lines")
}

model AuditLog {
  id         String  @id @default(uuid())
  entityType String  @map("entity_type") // invoice, user, company, etc.
  entityId   String  @map("entity_id")
  action     String // created, updated, deleted, sent, cancelled, etc.
  oldData    Json?   @map("old_data")
  newData    Json?   @map("new_data")
  userId     String? @map("user_id")
  ipAddress  String? @map("ip_address")
  userAgent  String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  // invoice Invoice? @relation(fields: [entityId], references: [id], onDelete: Cascade)

  // Indexes for performance
  // Single-column indexes
  @@index([entityType])
  @@index([entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  
  // Composite indexes for audit queries
  @@index([entityType, entityId, createdAt(sort: Desc)])
  @@index([entityType, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, action, createdAt(sort: Desc)])
  @@index([entityType, action, createdAt(sort: Desc)])
  
  @@map("audit_logs")
}

model SEFWebhookLog {
  id         String   @id @default(uuid())
  eventType  String   @map("event_type")
  sefId      String   @map("sef_id")
  payload    Json
  signature  String
  processed  Boolean  @default(false)
  error      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  receivedAt DateTime @default(now()) @map("received_at")

  // Indexes for performance
  @@index([sefId])
  @@index([processed])
  @@index([eventType])
  @@index([createdAt])
  @@index([sefId, processed])
  @@index([processed, createdAt])
  @@map("sef_webhook_logs")
}

model JobQueue {
  id          String    @id @default(uuid())
  type        String // send_invoice, webhook_process, etc.
  payload     Json
  status      JobStatus @default(PENDING)
  attempts    Int       @default(0)
  maxAttempts Int       @default(3) @map("max_attempts")
  error       String?   @db.Text
  scheduledAt DateTime? @map("scheduled_at")

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  processedAt DateTime? @map("processed_at")

  // Indexes for performance
  @@index([status])
  @@index([type])
  @@index([scheduledAt])
  @@index([createdAt])
  @@index([status, scheduledAt])
  @@index([type, status])
  @@map("job_queue")
}

// ========================================
// PAYMENT MODEL (Plaćanja)
// ========================================
model Payment {
  id        String @id @default(uuid())
  invoiceId String @map("invoice_id")

  // Iznos plaćanja
  amount   Decimal @db.Decimal(15, 2)
  currency String  @default("RSD")

  // Datum i metod
  paymentDate DateTime      @map("payment_date")
  method      PaymentMethod

  // Bankarski podaci
  bankAccount String? @map("bank_account")
  reference   String? // Poziv na broj / referenca plaćanja

  // Status
  status PaymentStatus @default(PENDING)

  // Detalji
  description String? @db.Text

  // Audit trail
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Indexes
  // Single-column indexes
  @@index([invoiceId])
  @@index([paymentDate])
  @@index([status])
  @@index([createdAt])
  @@index([method])
  
  // Composite indexes for payment queries
  @@index([invoiceId, status])
  @@index([invoiceId, paymentDate(sort: Desc)])
  @@index([status, paymentDate])
  @@index([createdAt(sort: Desc), status])
  
  @@map("payments")
}

// Enums
enum PaymentMethod {
  CASH // Gotovina
  BANK_TRANSFER // Virman
  CARD // Kartica
  CHECK // Ček
  COMPENSATION // Kompenzacija
  OTHER // Ostalo
}

enum PaymentStatus {
  PENDING // Na čekanju
  CLEARED // Proknjiženo
  BOUNCED // Vraćeno (ček)
  CANCELLED // Otkazano
}

enum UserRole {
  ADMIN
  ACCOUNTANT
  AUDITOR
  OPERATOR
}

enum InvoiceStatus {
  DRAFT
  SENT
  DELIVERED
  ACCEPTED
  REJECTED
  CANCELLED
  STORNO
  EXPIRED
}

enum InvoiceType {
  OUTGOING
  INCOMING
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ========================================
// ACCOUNTING MODULE - KONTNI PLAN (Chart of Accounts)
// ========================================

model Account {
  id          String      @id @default(uuid())
  code        String      // Konto broj (npr. 2020, 4310)
  name        String      // Naziv konta
  nameEn      String?     @map("name_en") // English name
  description String?     @db.Text
  
  // Hijerarhija
  level       Int         // 1=klasa, 2=grupa, 3=sintetika, 4=analitika
  parentId    String?     @map("parent_id")
  parent      Account?    @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    Account[]   @relation("AccountHierarchy")
  
  // Tip konta
  type        AccountType
  normalSide  AccountSide @map("normal_side") // Duguje ili Potražuje
  
  // Status
  isActive    Boolean     @default(true) @map("is_active")
  isSystem    Boolean     @default(false) @map("is_system") // Sistemski konto (ne može se brisati)
  
  // Company relation
  companyId   String      @map("company_id")
  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  // Relations
  journalLines JournalLine[]
  
  @@unique([companyId, code])
  @@index([companyId])
  @@index([parentId])
  @@index([type])
  @@index([level])
  @@index([isActive])
  @@index([companyId, level, code])
  @@map("accounts")
}

enum AccountType {
  ASSET           // Aktiva (klasa 0,1,2,3)
  LIABILITY       // Pasiva - Obaveze (klasa 4)
  EQUITY          // Kapital (klasa 3)
  REVENUE         // Prihodi (klasa 6)
  EXPENSE         // Rashodi (klasa 5)
  COST            // Troškovi (klasa 5)
  OFF_BALANCE     // Vanbilansna evidencija (klasa 8,9)
}

enum AccountSide {
  DEBIT   // Duguje
  CREDIT  // Potražuje
}

// ========================================
// FISCAL YEAR - Poslovna godina
// ========================================

model FiscalYear {
  id          String    @id @default(uuid())
  year        Int       // Godina (2024, 2025, ...)
  startDate   DateTime  @map("start_date")
  endDate     DateTime  @map("end_date")
  
  // Status
  status      FiscalYearStatus @default(OPEN)
  closedAt    DateTime?        @map("closed_at")
  closedBy    String?          @map("closed_by")
  
  // Company relation
  companyId   String    @map("company_id")
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  // Relations
  journals    JournalEntry[]
  
  @@unique([companyId, year])
  @@index([companyId])
  @@index([status])
  @@map("fiscal_years")
}

enum FiscalYearStatus {
  OPEN      // Otvorena - dozvoljena knjiženja
  LOCKED    // Zaključana - privremeno (za izveštaje)
  CLOSED    // Zatvorena - završna knjiženja urađena
}

// ========================================
// JOURNAL ENTRY - Nalog za knjiženje
// ========================================

model JournalEntry {
  id              String          @id @default(uuid())
  entryNumber     String          @map("entry_number") // Redni broj naloga
  date            DateTime        // Datum knjiženja
  description     String          @db.Text
  
  // Tip naloga
  type            JournalType     @default(MANUAL)
  
  // Reference (opciono)
  referenceType   String?         @map("reference_type") // invoice, payment, bank_statement
  referenceId     String?         @map("reference_id")
  
  // Fiscal year
  fiscalYearId    String          @map("fiscal_year_id")
  fiscalYear      FiscalYear      @relation(fields: [fiscalYearId], references: [id])
  
  // Status
  status          JournalStatus   @default(DRAFT)
  postedAt        DateTime?       @map("posted_at")
  postedBy        String?         @map("posted_by")
  
  // Totals (cached for performance)
  totalDebit      Decimal         @default(0) @map("total_debit") @db.Decimal(15, 2)
  totalCredit     Decimal         @default(0) @map("total_credit") @db.Decimal(15, 2)
  
  // Company relation
  companyId       String          @map("company_id")
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Audit
  createdBy       String          @map("created_by")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  
  // Relations
  lines           JournalLine[]
  
  @@unique([companyId, entryNumber, fiscalYearId])
  @@index([companyId])
  @@index([fiscalYearId])
  @@index([date])
  @@index([status])
  @@index([type])
  @@index([referenceType, referenceId])
  @@index([companyId, date(sort: Desc)])
  @@index([companyId, status, date])
  @@map("journal_entries")
}

enum JournalType {
  MANUAL          // Ručni unos
  INVOICE         // Automatski od fakture
  PAYMENT         // Automatski od plaćanja
  BANK_STATEMENT  // Automatski od izvoda
  CLOSING         // Završno knjiženje
  OPENING         // Početno stanje
  ADJUSTMENT      // Korekcija
}

enum JournalStatus {
  DRAFT     // Nacrt
  POSTED    // Proknjiženo
  REVERSED  // Stornirano
}

// ========================================
// JOURNAL LINE - Stavka naloga za knjiženje
// ========================================

model JournalLine {
  id              String        @id @default(uuid())
  lineNumber      Int           @map("line_number")
  
  // Account
  accountId       String        @map("account_id")
  account         Account       @relation(fields: [accountId], references: [id])
  
  // Amounts
  debitAmount     Decimal       @default(0) @map("debit_amount") @db.Decimal(15, 2)
  creditAmount    Decimal       @default(0) @map("credit_amount") @db.Decimal(15, 2)
  
  // Description (per line)
  description     String?       @db.Text
  
  // Partner reference (for A/R and A/P)
  partnerId       String?       @map("partner_id")
  
  // Journal entry relation
  journalEntryId  String        @map("journal_entry_id")
  journalEntry    JournalEntry  @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  
  @@index([journalEntryId])
  @@index([accountId])
  @@index([partnerId])
  @@index([journalEntryId, lineNumber])
  @@map("journal_lines")
}

// ========================================
// VAT EVIDENCE - PDV Evidencija
// ========================================

model VATRecord {
  id              String        @id @default(uuid())
  
  // Period
  year            Int
  month           Int           // 1-12
  
  // Tip evidencije
  type            VATRecordType
  
  // Document info
  documentNumber  String        @map("document_number")
  documentDate    DateTime      @map("document_date")
  partnerName     String        @map("partner_name")
  partnerPIB      String        @map("partner_pib")
  
  // Amounts
  taxBase20       Decimal       @default(0) @map("tax_base_20") @db.Decimal(15, 2)  // Osnovica 20%
  vatAmount20     Decimal       @default(0) @map("vat_amount_20") @db.Decimal(15, 2) // PDV 20%
  taxBase10       Decimal       @default(0) @map("tax_base_10") @db.Decimal(15, 2)  // Osnovica 10%
  vatAmount10     Decimal       @default(0) @map("vat_amount_10") @db.Decimal(15, 2) // PDV 10%
  exemptAmount    Decimal       @default(0) @map("exempt_amount") @db.Decimal(15, 2) // Oslobođeno
  totalAmount     Decimal       @default(0) @map("total_amount") @db.Decimal(15, 2)
  
  // Reference
  invoiceId       String?       @map("invoice_id")
  
  // Company relation
  companyId       String        @map("company_id")
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  
  @@index([companyId])
  @@index([year, month])
  @@index([type])
  @@index([invoiceId])
  @@index([companyId, year, month, type])
  @@map("vat_records")
}

enum VATRecordType {
  OUTPUT    // Izlazni PDV (prodaja)
  INPUT     // Ulazni PDV (nabavka)
}

// ========================================
// BANK STATEMENT - Izvod
// ========================================

model BankStatement {
  id              String              @id @default(uuid())
  
  // Statement info
  statementNumber String              @map("statement_number")
  accountNumber   String              @map("account_number") // IBAN ili broj računa
  bankName        String?             @map("bank_name")
  
  // Period
  statementDate   DateTime            @map("statement_date")
  fromDate        DateTime            @map("from_date")
  toDate          DateTime            @map("to_date")
  
  // Balances
  openingBalance  Decimal             @map("opening_balance") @db.Decimal(15, 2)
  closingBalance  Decimal             @map("closing_balance") @db.Decimal(15, 2)
  totalDebit      Decimal             @default(0) @map("total_debit") @db.Decimal(15, 2)
  totalCredit     Decimal             @default(0) @map("total_credit") @db.Decimal(15, 2)
  
  // Status
  status          BankStatementStatus @default(IMPORTED)
  processedAt     DateTime?           @map("processed_at")
  
  // Company relation
  companyId       String              @map("company_id")
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  
  // Relations
  transactions    BankTransaction[]
  
  @@unique([companyId, accountNumber, statementNumber])
  @@index([companyId])
  @@index([statementDate])
  @@index([status])
  @@map("bank_statements")
}

enum BankStatementStatus {
  IMPORTED    // Uvezen
  PROCESSING  // U obradi
  MATCHED     // Upareno
  POSTED      // Proknjiženo
}

model BankTransaction {
  id                String              @id @default(uuid())
  
  // Transaction info
  transactionDate   DateTime            @map("transaction_date")
  valueDate         DateTime?           @map("value_date")
  
  // Amounts
  amount            Decimal             @db.Decimal(15, 2)
  type              BankTransactionType
  
  // Partner info
  partnerName       String?             @map("partner_name")
  partnerAccount    String?             @map("partner_account")
  
  // Reference
  reference         String?             // Poziv na broj
  description       String?             @db.Text
  
  // Matching
  matchStatus       MatchStatus         @default(UNMATCHED) @map("match_status")
  matchedInvoiceId  String?             @map("matched_invoice_id")
  matchedPaymentId  String?             @map("matched_payment_id")
  
  // Statement relation
  statementId       String              @map("statement_id")
  statement         BankStatement       @relation(fields: [statementId], references: [id], onDelete: Cascade)
  
  @@index([statementId])
  @@index([transactionDate])
  @@index([matchStatus])
  @@index([matchedInvoiceId])
  @@map("bank_transactions")
}

enum BankTransactionType {
  CREDIT  // Uplata
  DEBIT   // Isplata
}

enum MatchStatus {
  UNMATCHED   // Nije upareno
  MATCHED     // Upareno
  PARTIAL     // Delimično upareno
  IGNORED     // Ignorisano (nije potrebno uparivanje)
}

// ========================================
// CREDIT NOTE - Knjižno odobrenje
// ========================================

model CreditNote {
  id                String          @id @default(uuid())
  creditNoteNumber  String          @map("credit_note_number")
  
  // Related invoice
  originalInvoiceId String          @map("original_invoice_id")
  
  // Partner
  partnerId         String?         @map("partner_id")
  partnerName       String          @map("partner_name")
  partnerPIB        String          @map("partner_pib")
  
  // Dates
  issueDate         DateTime        @map("issue_date")
  
  // Amounts
  totalAmount       Decimal         @map("total_amount") @db.Decimal(15, 2)
  taxAmount         Decimal         @map("tax_amount") @db.Decimal(15, 2)
  
  // Reason
  reason            String          @db.Text
  
  // SEF
  sefId             String?         @unique @map("sef_id")
  sefStatus         String?         @map("sef_status")
  sentAt            DateTime?       @map("sent_at")
  
  // Status
  status            CreditNoteStatus @default(DRAFT)
  
  // Company relation
  companyId         String          @map("company_id")
  company           Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  
  // Relations
  lines             CreditNoteLine[]
  
  @@unique([companyId, creditNoteNumber])
  @@index([companyId])
  @@index([originalInvoiceId])
  @@index([status])
  @@map("credit_notes")
}

model CreditNoteLine {
  id              String      @id @default(uuid())
  lineNumber      Int         @map("line_number")
  
  itemName        String      @map("item_name")
  quantity        Decimal     @db.Decimal(10, 3)
  unitPrice       Decimal     @map("unit_price") @db.Decimal(15, 2)
  taxRate         Decimal     @map("tax_rate") @db.Decimal(5, 2)
  taxAmount       Decimal     @map("tax_amount") @db.Decimal(15, 2)
  amount          Decimal     @db.Decimal(15, 2)
  
  creditNoteId    String      @map("credit_note_id")
  creditNote      CreditNote  @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  
  @@index([creditNoteId])
  @@map("credit_note_lines")
}

enum CreditNoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  CANCELLED
}

// ========================================
// INCOMING INVOICE - Ulazne fakture
// ========================================

model IncomingInvoice {
  id                String                @id @default(uuid())
  
  // SEF reference
  sefId             String?               @unique @map("sef_id")
  sefStatus         String?               @map("sef_status")
  
  // Invoice info
  invoiceNumber     String                @map("invoice_number")
  issueDate         DateTime              @map("issue_date")
  dueDate           DateTime?             @map("due_date")
  receivedDate      DateTime              @default(now()) @map("received_date")
  
  // Supplier info
  supplierName      String                @map("supplier_name")
  supplierPIB       String                @map("supplier_pib")
  supplierAddress   String?               @map("supplier_address")
  
  // Amounts
  totalAmount       Decimal               @map("total_amount") @db.Decimal(15, 2)
  taxAmount         Decimal               @map("tax_amount") @db.Decimal(15, 2)
  currency          String                @default("RSD")
  
  // Status
  status            IncomingInvoiceStatus @default(RECEIVED)
  
  // Processing
  acceptedAt        DateTime?             @map("accepted_at")
  rejectedAt        DateTime?             @map("rejected_at")
  rejectionReason   String?               @map("rejection_reason") @db.Text
  
  // Payment
  paymentStatus     InvoicePaymentStatus  @default(UNPAID) @map("payment_status")
  paidAmount        Decimal               @default(0) @map("paid_amount") @db.Decimal(15, 2)
  
  // Company relation
  companyId         String                @map("company_id")
  company           Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Optional partner link
  partnerId         String?               @map("partner_id")
  
  // Timestamps
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")
  
  // Relations
  lines             IncomingInvoiceLine[]
  calculations      Calculation[]
  
  @@index([companyId])
  @@index([sefId])
  @@index([status])
  @@index([paymentStatus])
  @@index([supplierPIB])
  @@index([companyId, status, receivedDate(sort: Desc)])
  @@map("incoming_invoices")
}

model IncomingInvoiceLine {
  id                  String          @id @default(uuid())
  lineNumber          Int             @map("line_number")
  
  itemName            String          @map("item_name")
  quantity            Decimal         @db.Decimal(10, 3)
  unitPrice           Decimal         @map("unit_price") @db.Decimal(15, 2)
  taxRate             Decimal         @map("tax_rate") @db.Decimal(5, 2)
  taxAmount           Decimal         @map("tax_amount") @db.Decimal(15, 2)
  amount              Decimal         @db.Decimal(15, 2)
  
  incomingInvoiceId   String          @map("incoming_invoice_id")
  incomingInvoice     IncomingInvoice @relation(fields: [incomingInvoiceId], references: [id], onDelete: Cascade)

  // Product mapping (NEW)
  productId           String?         @map("product_id")
  product             Product?        @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  @@index([incomingInvoiceId])
  @@index([productId])
  @@map("incoming_invoice_lines")
}

enum IncomingInvoiceStatus {
  RECEIVED    // Primljena
  PENDING     // Čeka odobrenje
  ACCEPTED    // Prihvaćena
  REJECTED    // Odbijena
  CANCELLED   // Otkazana
}

// ========================================
// NOTIFICATION MODEL (Notifikacije)
// ========================================
model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   // INVOICE_SENT, INVOICE_ACCEPTED, PAYMENT_RECEIVED, etc.
  title     String
  message   String   @db.Text
  data      Json?    @default("{}")
  isRead    Boolean  @default(false) @map("is_read")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@index([type])
  @@map("notifications")
}

// ========================================
// RECURRING INVOICE - Periodične fakture
// ========================================

model RecurringInvoice {
  id              String                  @id @default(uuid())
  
  // Schedule
  frequency       RecurringFrequency
  startDate       DateTime                @map("start_date")
  endDate         DateTime?               @map("end_date")
  nextRunAt       DateTime                @map("next_run_at")
  lastRunAt       DateTime?               @map("last_run_at")
  
  // Status
  status          RecurringInvoiceStatus  @default(ACTIVE)
  
  // Template Data (Snapshot of invoice data)
  partnerId       String                  @map("partner_id")
  partner         Partner                 @relation(fields: [partnerId], references: [id])
  
  currency        String                  @default("RSD")
  items           Json                    // Array of items { name, quantity, price, etc. }
  note            String?                 @db.Text
  
  // Company relation
  companyId       String                  @map("company_id")
  company         Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Audit
  createdBy       String                  @map("created_by")
  createdAt       DateTime                @default(now()) @map("created_at")
  updatedAt       DateTime                @updatedAt @map("updated_at")
  
  @@index([companyId])
  @@index([status])
  @@index([nextRunAt])
  @@map("recurring_invoices")
}

enum RecurringFrequency {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum RecurringInvoiceStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// ========================================
// INVENTORY TRANSACTION - Promene na zalihama
// ========================================
model InventoryTransaction {
  id          String    @id @default(uuid())
  
  // Product
  productId   String    @map("product_id")
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Transaction details
  type        InventoryTransactionType
  quantity    Decimal   @db.Decimal(15, 3) // Positive for add, negative for deduct
  
  // Stock snapshot (after transaction)
  stockBefore Decimal   @map("stock_before") @db.Decimal(15, 3)
  stockAfter  Decimal   @map("stock_after") @db.Decimal(15, 3)
  
  // Reference
  referenceType String? @map("reference_type") // invoice, incoming_invoice, adjustment, initial
  referenceId   String? @map("reference_id")
  
  // Metadata
  note        String?   @db.Text
  
  // Company relation
  companyId   String    @map("company_id")
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Audit
  createdBy   String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  
  @@index([companyId])
  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@index([referenceType, referenceId])
  @@map("inventory_transactions")
}

enum InventoryTransactionType {
  INITIAL       // Početno stanje
  PURCHASE      // Nabavka (Ulazna faktura)
  SALE          // Prodaja (Izlazna faktura)
  RETURN_IN     // Povraćaj od kupca
  RETURN_OUT    // Povraćaj dobavljaču
  ADJUSTMENT    // Korekcija (popis)
  DAMAGE        // Otpis (kalo, rastur)
  TRANSFER      // Prenos
}

// ========================================
// CALCULATION - Kalkulacija cena (Trgovina)
// ========================================
model Calculation {
  id              String            @id @default(uuid())
  number          String            @map("number") // Broj kalkulacije
  date            DateTime          @map("date")
  
  // Veza sa ulaznom fakturom
  incomingInvoiceId String?         @map("incoming_invoice_id")
  incomingInvoice   IncomingInvoice? @relation(fields: [incomingInvoiceId], references: [id])
  
  // Dobavljač (ako nema ulazne fakture, npr. početno stanje)
  partnerId       String?           @map("partner_id")
  partner         Partner?          @relation(fields: [partnerId], references: [id])
  
  // Magacin
  warehouse       String?           @default("Centralni magacin")
  
  // Totals
  totalWholesale  Decimal           @default(0) @map("total_wholesale") @db.Decimal(15, 2) // Nabavna vrednost
  totalExpenses   Decimal           @default(0) @map("total_expenses") @db.Decimal(15, 2) // Zavisni troškovi
  totalMargin     Decimal           @default(0) @map("total_margin") @db.Decimal(15, 2) // Razlika u ceni
  totalRetail     Decimal           @default(0) @map("total_retail") @db.Decimal(15, 2) // Prodajna vrednost sa PDV
  
  // Status
  status          CalculationStatus @default(DRAFT)
  postedAt        DateTime?         @map("posted_at")
  
  // Company relation
  companyId       String            @map("company_id")
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Audit
  createdBy       String            @map("created_by")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  
  // Relations
  items           CalculationItem[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([date])
  @@index([status])
  @@map("calculations")
}

model CalculationItem {
  id              String      @id @default(uuid())
  calculationId   String      @map("calculation_id")
  calculation     Calculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)
  
  // Proizvod
  productId       String      @map("product_id")
  product         Product     @relation(fields: [productId], references: [id])
  
  quantity        Decimal     @db.Decimal(10, 3)
  
  // Cene (po jedinici)
  supplierPrice   Decimal     @map("supplier_price") @db.Decimal(15, 2) // Fakturna cena
  expensePerUnit  Decimal     @default(0) @map("expense_per_unit") @db.Decimal(15, 2) // Zavisni trošak po jedinici
  costPrice       Decimal     @map("cost_price") @db.Decimal(15, 2) // Nabavna cena (Fakturna + Trošak)
  
  marginPercent   Decimal     @default(0) @map("margin_percent") @db.Decimal(5, 2) // Marža %
  marginAmount    Decimal     @default(0) @map("margin_amount") @db.Decimal(15, 2) // Marža iznos
  
  salesPriceNoVat Decimal     @map("sales_price_no_vat") @db.Decimal(15, 2) // Prodajna bez PDV
  vatRate         Decimal     @map("vat_rate") @db.Decimal(5, 2)
  salesPrice      Decimal     @map("sales_price") @db.Decimal(15, 2) // Prodajna sa PDV
  
  @@index([calculationId])
  @@index([productId])
  @@map("calculation_items")
}

enum CalculationStatus {
  DRAFT
  POSTED    // Proknjiženo (ažuriralo zalihe i cene)
  CANCELLED
}

// ========================================
// FIXED ASSETS - Osnovna sredstva
// ========================================
model FixedAsset {
  id              String            @id @default(uuid())
  inventoryNumber String            @map("inventory_number") // Inventarski broj
  name            String
  
  // Nabavka
  purchaseDate    DateTime          @map("purchase_date")
  purchaseValue   Decimal           @map("purchase_value") @db.Decimal(15, 2)
  supplierId      String?           @map("supplier_id")
  invoiceNumber   String?           @map("invoice_number")
  
  // Amortizacija
  amortizationRate Decimal          @map("amortization_rate") @db.Decimal(5, 2) // Stopa amortizacije %
  currentValue    Decimal           @map("current_value") @db.Decimal(15, 2) // Sadašnja vrednost
  accumulatedAmortization Decimal   @default(0) @map("accumulated_amortization") @db.Decimal(15, 2)
  
  // Status
  status          FixedAssetStatus  @default(ACTIVE)
  location        String?
  employee        String?           // Zaduženo lice
  
  // Company relation
  companyId       String            @map("company_id")
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  
  @@unique([companyId, inventoryNumber])
  @@index([companyId])
  @@index([status])
  @@map("fixed_assets")
}

enum FixedAssetStatus {
  ACTIVE
  WRITTEN_OFF   // Otpisano
  SOLD          // Prodato
}

// ========================================
// PETTY CASH - Blagajna
// ========================================
model PettyCashAccount {
  id              String            @id @default(uuid())
  name            String            @default("Glavna blagajna")
  currency        String            @default("RSD")
  balance         Decimal           @default(0) @db.Decimal(15, 2)
  
  // Company relation
  companyId       String            @map("company_id")
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  entries         PettyCashEntry[]
  
  @@index([companyId])
  @@map("petty_cash_accounts")
}

model PettyCashEntry {
  id              String            @id @default(uuid())
  accountId       String            @map("account_id")
  account         PettyCashAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  entryNumber     String            @map("entry_number") // Broj naloga
  date            DateTime
  type            PettyCashType     // UPLATA ili ISPLATA
  
  amount          Decimal           @db.Decimal(15, 2)
  description     String            @db.Text
  
  // Partner (opciono)
  partnerId       String?           @map("partner_id")
  partnerName     String?           @map("partner_name") // Za fizička lica
  
  // Veza sa troškovima/fakturama
  expenseCategory String?           @map("expense_category") // Npr. "Gorivo", "Reprezentacija"
  
  createdAt       DateTime          @default(now()) @map("created_at")
  createdBy       String            @map("created_by")
  
  @@index([accountId])
  @@index([date])
  @@index([type])
  @@map("petty_cash_entries")
}

enum PettyCashType {
  DEPOSIT     // Uplata (Ulaz)
  WITHDRAWAL  // Isplata (Izlaz)
}

// ========================================
// TRAVEL ORDERS - Putni nalozi
// ========================================
model TravelOrder {
  id              String            @id @default(uuid())
  orderNumber     String            @map("order_number")
  
  employeeName    String            @map("employee_name")
  employeeId      String?           @map("employee_id") // Optional link to User or Partner
  
  vehicle         String?           // Vozilo
  
  // Relacija
  destination     String
  country         String            @default("RS")
  departureDate   DateTime          @map("departure_date")
  returnDate      DateTime          @map("return_date")
  
  // Troškovi
  advanceAmount   Decimal           @default(0) @map("advance_amount") @db.Decimal(15, 2) // Akontacija
  totalExpenses   Decimal           @default(0) @map("total_expenses") @db.Decimal(15, 2)
  totalPayout     Decimal           @default(0) @map("total_payout") @db.Decimal(15, 2) // Isplata (Total - Akontacija)
  
  status          TravelOrderStatus @default(DRAFT)
  
  expenses        TravelOrderExpense[]
  
  // Company relation
  companyId       String            @map("company_id")
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  
  @@unique([companyId, orderNumber])
  @@index([companyId])
  @@index([status])
  @@map("travel_orders")
}

model TravelOrderExpense {
  id            String      @id @default(uuid())
  travelOrderId String      @map("travel_order_id")
  travelOrder   TravelOrder @relation(fields: [travelOrderId], references: [id], onDelete: Cascade)
  
  type          String      // DAILY_ALLOWANCE, TOLL, FUEL, etc.
  date          DateTime
  amount        Decimal     @db.Decimal(15, 2)
  currency      String      @default("RSD")
  description   String?     @db.Text
  attachmentUrl String?     @map("attachment_url")
  
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  @@index([travelOrderId])
  @@map("travel_order_expenses")
}

enum TravelOrderStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  PAID
}

// ========================================
// SEF VAT EVIDENCE - Pojedinačna/Zbirna evidencija PDV
// ========================================
model SefVatEvidence {
  id              String            @id @default(uuid())
  
  period          String            // YYYY-MM
  type            SefVatType        // INDIVIDUAL or SUMMARY
  
  // Sadržaj
  taxPeriod       String            @map("tax_period") // Npr. "2025-11"
  documentNumber  String?           @map("document_number") // Za pojedinačnu
  issueDate       DateTime?         @map("issue_date")
  
  // Iznosi
  taxBase         Decimal           @map("tax_base") @db.Decimal(15, 2)
  taxAmount       Decimal           @map("tax_amount") @db.Decimal(15, 2)
  totalAmount     Decimal           @map("total_amount") @db.Decimal(15, 2)
  
  // SEF Status
  sefId           String?           @map("sef_id")
  status          String            @default("PENDING") // PENDING, SENT, ERROR
  
  // Company relation
  companyId       String            @map("company_id")
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime          @default(now()) @map("created_at")
  
  @@index([companyId])
  @@index([period])
  @@index([status])
  @@map("sef_vat_evidence")
}

enum SefVatType {
  INDIVIDUAL  // Pojedinačna evidencija
  SUMMARY     // Zbirna evidencija
}

// ========================================
// PPPDV - PDV PRIJAVA
// ========================================
model PPPDVReport {
  id              String            @id @default(uuid())
  
  // Period
  year            Int
  month           Int               // 1-12 (mesečno) ili kvartalno (3,6,9,12)
  periodType      PPPDVPeriodType   @default(MONTHLY) @map("period_type")
  
  // Iznosi - Izlazni PDV (promet dobara i usluga)
  field001        Decimal           @default(0) @db.Decimal(15, 2) // Promet po opštoj stopi (20%) - osnovica
  field002        Decimal           @default(0) @db.Decimal(15, 2) // Promet po opštoj stopi (20%) - PDV
  field003        Decimal           @default(0) @db.Decimal(15, 2) // Promet po posebnoj stopi (10%) - osnovica
  field004        Decimal           @default(0) @db.Decimal(15, 2) // Promet po posebnoj stopi (10%) - PDV
  field005        Decimal           @default(0) @db.Decimal(15, 2) // Promet oslobođen PDV
  field006        Decimal           @default(0) @db.Decimal(15, 2) // Promet van RS (izvoz)
  
  // Ulazni PDV (prethodni porez)
  field101        Decimal           @default(0) @db.Decimal(15, 2) // Nabavka dobara i usluga 20% - osnovica
  field102        Decimal           @default(0) @db.Decimal(15, 2) // Nabavka dobara i usluga 20% - PDV
  field103        Decimal           @default(0) @db.Decimal(15, 2) // Nabavka dobara i usluga 10% - osnovica
  field104        Decimal           @default(0) @db.Decimal(15, 2) // Nabavka dobara i usluga 10% - PDV
  field105        Decimal           @default(0) @db.Decimal(15, 2) // Uvoz dobara 20% - PDV
  field106        Decimal           @default(0) @db.Decimal(15, 2) // Uvoz dobara 10% - PDV
  
  // Obračun
  field201        Decimal           @default(0) @db.Decimal(15, 2) // Ukupan izlazni PDV (002 + 004)
  field202        Decimal           @default(0) @db.Decimal(15, 2) // Ukupan ulazni PDV (102 + 104 + 105 + 106)
  field203        Decimal           @default(0) @db.Decimal(15, 2) // PDV za uplatu (201 - 202, ako > 0)
  field204        Decimal           @default(0) @db.Decimal(15, 2) // PDV za povraćaj (202 - 201, ako > 0)
  
  // Status
  status          PPPDVStatus       @default(DRAFT)
  submittedAt     DateTime?         @map("submitted_at")
  
  // Company relation
  companyId       String            @map("company_id")
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  
  @@unique([companyId, year, month])
  @@index([companyId])
  @@index([year, month])
  @@index([status])
  @@map("pppdv_reports")
}

enum PPPDVPeriodType {
  MONTHLY     // Mesečno
  QUARTERLY   // Kvartalno
}

enum PPPDVStatus {
  DRAFT       // Nacrt
  CALCULATED  // Izračunato
  SUBMITTED   // Predato
  CORRECTED   // Korigovano
}

// ========================================
// KPO - KNJIGA PROMETA OBVEZNIKA
// ========================================
model KPOEntry {
  id              String            @id @default(uuid())
  
  date            DateTime          // Datum prometa
  ordinalNumber   Int               @map("ordinal_number") // Redni broj u knjizi
  
  // Opis prometa
  description     String            @db.Text
  documentNumber  String?           @map("document_number") // Broj dokumenta
  documentType    String?           @map("document_type") // Tip dokumenta (faktura, račun, etc.)
  
  // Iznosi
  grossIncome     Decimal           @default(0) @map("gross_income") @db.Decimal(15, 2) // Bruto prihod
  vatAmount       Decimal           @default(0) @map("vat_amount") @db.Decimal(15, 2) // PDV
  netIncome       Decimal           @default(0) @map("net_income") @db.Decimal(15, 2) // Neto prihod
  
  // Za rashode
  expense         Decimal           @default(0) @db.Decimal(15, 2) // Rashod
  
  // Veza sa fakturom
  invoiceId       String?           @map("invoice_id")
  
  // Company relation
  companyId       String            @map("company_id")
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime          @default(now()) @map("created_at")
  
  @@index([companyId])
  @@index([date])
  @@index([companyId, date])
  @@map("kpo_entries")
}

// ========================================
// KOMPENZACIJE
// ========================================
model Compensation {
  id              String              @id @default(uuid())
  number          String              // Broj kompenzacije
  date            DateTime            // Datum kompenzacije
  
  // Strane u kompenzaciji
  partnerId       String              @map("partner_id")
  partner         Partner             @relation(fields: [partnerId], references: [id])
  
  // Iznosi
  totalAmount     Decimal             @map("total_amount") @db.Decimal(15, 2) // Ukupan iznos kompenzacije
  
  // Status
  status          CompensationStatus  @default(DRAFT)
  signedAt        DateTime?           @map("signed_at")
  
  // Notes
  note            String?             @db.Text
  
  // Company relation
  companyId       String              @map("company_id")
  company         Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Relations
  items           CompensationItem[]
  
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([partnerId])
  @@index([date])
  @@index([status])
  @@map("compensations")
}

model CompensationItem {
  id              String            @id @default(uuid())
  compensationId  String            @map("compensation_id")
  compensation    Compensation      @relation(fields: [compensationId], references: [id], onDelete: Cascade)
  
  // Tip stavke
  type            CompensationItemType
  
  // Veza sa dokumentom
  invoiceId       String?           @map("invoice_id") // Može biti izlazna ili ulazna faktura
  documentNumber  String            @map("document_number")
  documentDate    DateTime          @map("document_date")
  
  // Iznos
  originalAmount  Decimal           @map("original_amount") @db.Decimal(15, 2) // Originalni iznos
  compensatedAmount Decimal         @map("compensated_amount") @db.Decimal(15, 2) // Kompenzovani iznos
  remainingAmount Decimal           @map("remaining_amount") @db.Decimal(15, 2) // Preostalo
  
  @@index([compensationId])
  @@index([invoiceId])
  @@map("compensation_items")
}

enum CompensationStatus {
  DRAFT
  PENDING     // Poslato partneru
  SIGNED      // Potpisano
  CANCELLED
}

enum CompensationItemType {
  RECEIVABLE  // Naše potraživanje (mi dugujemo)
  PAYABLE     // Naša obaveza (partner duguje)
}

// ========================================
// IOS - IZVOD OTVORENIH STAVKI
// ========================================
model IOSReport {
  id              String            @id @default(uuid())
  number          String            // Broj IOS-a
  
  // Partner
  partnerId       String            @map("partner_id")
  partner         Partner           @relation(fields: [partnerId], references: [id])
  
  // Datum stanja
  asOfDate        DateTime          @map("as_of_date")
  
  // Ukupna stanja
  totalReceivable Decimal           @default(0) @map("total_receivable") @db.Decimal(15, 2) // Naše potraživanje
  totalPayable    Decimal           @default(0) @map("total_payable") @db.Decimal(15, 2) // Naša obaveza
  balance         Decimal           @default(0) @db.Decimal(15, 2) // Saldo (Receivable - Payable)
  
  // Status
  status          IOSStatus         @default(DRAFT)
  sentAt          DateTime?         @map("sent_at")
  confirmedAt     DateTime?         @map("confirmed_at")
  
  // Partner response
  partnerConfirmed Boolean          @default(false) @map("partner_confirmed")
  partnerNotes    String?           @map("partner_notes") @db.Text
  
  // Company relation
  companyId       String            @map("company_id")
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Relations
  items           IOSItem[]
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([partnerId])
  @@index([asOfDate])
  @@map("ios_reports")
}

model IOSItem {
  id              String            @id @default(uuid())
  iosReportId     String            @map("ios_report_id")
  iosReport       IOSReport         @relation(fields: [iosReportId], references: [id], onDelete: Cascade)
  
  // Dokument
  documentType    String            @map("document_type") // INVOICE, CREDIT_NOTE, PAYMENT
  documentNumber  String            @map("document_number")
  documentDate    DateTime          @map("document_date")
  dueDate         DateTime?         @map("due_date")
  
  // Iznosi
  debitAmount     Decimal           @default(0) @map("debit_amount") @db.Decimal(15, 2) // Duguje
  creditAmount    Decimal           @default(0) @map("credit_amount") @db.Decimal(15, 2) // Potražuje
  balance         Decimal           @default(0) @db.Decimal(15, 2) // Saldo
  
  // Reference
  invoiceId       String?           @map("invoice_id")
  
  @@index([iosReportId])
  @@map("ios_items")
}

enum IOSStatus {
  DRAFT
  SENT
  CONFIRMED
  DISPUTED
}

// ========================================
// NBS KURSNA LISTA
// ========================================
model ExchangeRate {
  id              String            @id @default(uuid())
  
  date            DateTime          // Datum kursa
  currencyCode    String            @map("currency_code") @db.VarChar(3) // EUR, USD, CHF, etc.
  currencyName    String            @map("currency_name") // Naziv valute
  
  country         String?           // Zemlja
  unit            Int               @default(1) // Jedinica (1, 100, etc.)
  
  buyingRate      Decimal           @map("buying_rate") @db.Decimal(15, 6) // Kupovni kurs
  middleRate      Decimal           @map("middle_rate") @db.Decimal(15, 6) // Srednji kurs
  sellingRate     Decimal           @map("selling_rate") @db.Decimal(15, 6) // Prodajni kurs
  
  source          String            @default("NBS") // Izvor (NBS, ECB, etc.)
  
  createdAt       DateTime          @default(now()) @map("created_at")
  
  @@unique([date, currencyCode])
  @@index([date])
  @@index([currencyCode])
  @@index([date, currencyCode])
  @@map("exchange_rates")
}

// ========================================
// AVANSNE FAKTURE
// ========================================
model AdvanceInvoice {
  id              String            @id @default(uuid())
  
  // Osnovni podaci
  invoiceNumber   String            @map("invoice_number")
  issueDate       DateTime          @map("issue_date")
  
  // Partner
  partnerId       String            @map("partner_id")
  partner         Partner           @relation(fields: [partnerId], references: [id])
  
  // Iznosi
  advanceAmount   Decimal           @map("advance_amount") @db.Decimal(15, 2) // Iznos avansa
  taxAmount       Decimal           @map("tax_amount") @db.Decimal(15, 2) // PDV
  totalAmount     Decimal           @map("total_amount") @db.Decimal(15, 2) // Ukupno
  currency        String            @default("RSD")
  
  // Zatvaranje
  usedAmount      Decimal           @default(0) @map("used_amount") @db.Decimal(15, 2) // Iskorišćeno
  remainingAmount Decimal           @map("remaining_amount") @db.Decimal(15, 2) // Preostalo
  
  // Veze sa konačnim fakturama
  closedByInvoices Json?            @map("closed_by_invoices") // Array of invoice IDs
  
  // Status
  status          AdvanceInvoiceStatus @default(DRAFT)
  
  // SEF
  sefId           String?           @unique @map("sef_id")
  sefStatus       String?           @map("sef_status")
  sentAt          DateTime?         @map("sent_at")
  
  // Company relation
  companyId       String            @map("company_id")
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  
  @@unique([companyId, invoiceNumber])
  @@index([companyId])
  @@index([partnerId])
  @@index([status])
  @@map("advance_invoices")
}

enum AdvanceInvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_USED  // Delimično iskorišćen
  FULLY_USED      // Potpuno iskorišćen
  CANCELLED
}

// ========================================
// EMAIL TEMPLATES & LOGS
// ========================================
model EmailTemplate {
  id              String            @id @default(uuid())
  
  name            String            // Naziv šablona
  type            EmailTemplateType // Tip šablona
  
  subject         String            // Naslov emaila
  bodyHtml        String            @map("body_html") @db.Text // HTML sadržaj
  bodyText        String?           @map("body_text") @db.Text // Plain text verzija
  
  // Variables available: {companyName}, {partnerName}, {invoiceNumber}, etc.
  variables       Json?             // Lista dostupnih varijabli
  
  isDefault       Boolean           @default(false) @map("is_default")
  isActive        Boolean           @default(true) @map("is_active")
  
  // Company relation (null = system template)
  companyId       String?           @map("company_id")
  company         Company?          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  
  @@index([companyId])
  @@index([type])
  @@map("email_templates")
}

model EmailLog {
  id              String            @id @default(uuid())
  
  // Recipient
  toEmail         String            @map("to_email")
  toName          String?           @map("to_name")
  
  // Content
  subject         String
  bodyHtml        String            @map("body_html") @db.Text
  
  // Reference
  templateId      String?           @map("template_id")
  referenceType   String?           @map("reference_type") // invoice, ios, reminder, etc.
  referenceId     String?           @map("reference_id")
  
  // Status
  status          EmailStatus       @default(PENDING)
  sentAt          DateTime?         @map("sent_at")
  errorMessage    String?           @map("error_message") @db.Text
  
  // Tracking
  openedAt        DateTime?         @map("opened_at")
  clickedAt       DateTime?         @map("clicked_at")
  
  // Company relation
  companyId       String            @map("company_id")
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime          @default(now()) @map("created_at")
  
  @@index([companyId])
  @@index([status])
  @@index([referenceType, referenceId])
  @@map("email_logs")
}

enum EmailTemplateType {
  INVOICE_SENT        // Faktura poslata
  PAYMENT_REMINDER    // Podsetnik za plaćanje
  PAYMENT_OVERDUE     // Faktura dospela
  IOS_REQUEST         // IOS zahtev
  COMPENSATION        // Kompenzacija
  WELCOME             // Dobrodošlica
  CUSTOM              // Prilagođeno
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

// ========================================
// CASH FLOW FORECAST
// ========================================
model CashFlowForecast {
  id              String            @id @default(uuid())
  
  date            DateTime          // Datum prognoze
  
  // Planirani prilivi
  expectedInflow  Decimal           @default(0) @map("expected_inflow") @db.Decimal(15, 2)
  actualInflow    Decimal           @default(0) @map("actual_inflow") @db.Decimal(15, 2)
  
  // Planirani odlivi
  expectedOutflow Decimal           @default(0) @map("expected_outflow") @db.Decimal(15, 2)
  actualOutflow   Decimal           @default(0) @map("actual_outflow") @db.Decimal(15, 2)
  
  // Saldo
  expectedBalance Decimal           @default(0) @map("expected_balance") @db.Decimal(15, 2)
  actualBalance   Decimal           @default(0) @map("actual_balance") @db.Decimal(15, 2)
  
  // Napomene
  notes           String?           @db.Text
  
  // Company relation
  companyId       String            @map("company_id")
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  
  @@unique([companyId, date])
  @@index([companyId])
  @@index([date])
  @@map("cash_flow_forecasts")
}

// ========================================
// PRODUCTION - Normativi (Sastavnice)
// ========================================
model ProductBOM {
  id              String            @id @default(uuid())
  
  // Gotov proizvod
  productId       String            @map("product_id")
  product         Product           @relation("ProductAsFinishedGood", fields: [productId], references: [id], onDelete: Cascade)
  
  // Komponenta (Materijal)
  componentId     String            @map("component_id")
  component       Product           @relation("ProductAsComponent", fields: [componentId], references: [id])
  
  quantity        Decimal           @db.Decimal(10, 4) // Koliko komponente ide u 1 gotov proizvod
  
  createdAt       DateTime          @default(now()) @map("created_at")
  
  @@index([productId])
  @@index([componentId])
  @@map("product_bom")
}
